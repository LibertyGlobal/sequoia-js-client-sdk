<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Javascript Client SDK Source: client.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cosmo.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html"><img class="branding-logo" src="https://pikselgroup.com/broadcast/wp-content/uploads/sites/3/2017/09/P-P-W.png"
		alt="logo"/>Javascript Client SDK</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="BusinessEndpoint.html">BusinessEndpoint</a></li><li><a href="Client.html">Client</a></li><li><a href="Predications.html">Predications</a></li><li><a href="Query.html">Query</a></li><li><a href="Registry.html">Registry</a></li><li><a href="Resource.html">Resource</a></li><li><a href="ResourceCollection.html">ResourceCollection</a></li><li><a href="ResourcefulEndpoint.html">ResourcefulEndpoint</a></li><li><a href="ServiceDescriptor.html">ServiceDescriptor</a></li><li><a href="Session.html">Session</a></li><li><a href="Transport.html">Transport</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="tutorials.list.html" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="tutorial-getting_started.html">Getting Started</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html#ValidationError">ValidationError</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: client.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">import Transport from './transport.js';
import Session from './session.js';
import Registry from './registry.js';
import {
  where, field, param, textSearch
} from './query.js';

/**
 * @typedef {Object} ClientOptions
 * Options for the Client.
 * @property {string} directory - The directory to pass through to {@link Session}.
 * @property {string} registryUri - The registryUri to pass through to {@link Registry}.
 * @property {string?} identityUri - Optional identityUri to pass through to {@link Session}.
 * @property {string?} token - Token to authenticate with.
 * @property {string?} tenant - Tenant to initialize with.
 * @property {boolean?} enableCache - Indicates whether to cache service descriptors in {@link Registry}.
 * @property {encodeUri?} encodeURI - Indicates whether to encode URIs before requesting in {@link Transport}.
 *                                    Will not re-encode existing sequences (e.g. `%20` will stay as `%20`, but `%2` will encode to `%202`)
 */

/**
 * Provides initial setup and subsequent access to the SDK
 *
 * @param {ClientOptions} options - Options for the Client.
 *
 * @property {Transport} transport - a stored transport instance used for fetching
 * @property {Session} session - a stored session to query the current users' authentication state with
 * @property {Registry} registry - a stored registry reference to query
 *
 * @requires {@link Transport}
 * @requires {@link Session}
 * @requires {@link Registry}
 *
 * @tutorial getting_started
 *
 * @example
 *
 * import Client from '@pikselpalette/sequoia-js-client-sdk/lib/client';
 * import { where, field } from '@pikselpalette/sequoia-js-client-sdk/lib/query';
 *
 * // Create a client:
 * const client = new Client({ directory: 'piksel',
 *                           registry: 'https://registry-sandbox.sequoia.piksel.com' });
 *
 * client.login('username', 'password').then(session => {
 *   // You can now query the session provided as the first argument (or
 *   // client.session); e.g. `session.isActive()`
 *
 *   // Get a service::
 *   client.service('metadata').then(service => {
 *     // Get a resourceful endpoint (this is synchronous as the service passed
 *     // all the necessary data):
 *     const contents = service.resourcefulEndpoint('contents');
 *
 *     contents.browse(where().fields('title', 'mediumSynopsis','duration', 'ref')
 *                     .include('assets').page(1).perPage(24).orderByUpdatedAt().desc().count())
 *             .then(json => {
 *               // Do something with the json returned
 *             });
 *   });
 * }).catch(error => {
 *   // Not logged in, inspect `error` to see why
 * });
 *
 * @example
 *
 * // Adding a tenant argument to the Client means you can skip setting the tenant later on.
 * const client = new Client({ directory: 'piksel',
 *                             registry: 'https://registry-sandbox.sequoia.piksel.com',
 *                             tenant: 'demo' });
 *
 * @example
 *
 * // Adding a token argument to the Client means you do not need to call generate()
 * // in a separate step.
 * const client = new Client({ directory: 'piksel',
 *                             registry: 'https://registry-sandbox.sequoia.piksel.com',
 *                             token: 'yourGeneratedToken' });
 */
class Client {
  constructor({
    directory,
    registryUri,
    identityUri,
    token,
    tenant,
    enableCache,
    encodeUri
  }) {
    this.transport = new Transport({}, encodeUri);
    this.registry = new Registry(this.transport, registryUri, enableCache);
    this.session = new Session(
      this.transport,
      directory,
      this.registry,
      identityUri
    );

    if (tenant) this.setTenancy(tenant);
    if (token) this.generate(token);
  }

  /**
   * Get a {@link ServiceDescriptor} from the {@link Registry}
   *
   * @deprecated Deprecated since 1.2.0. Use {@link Client#serviceDescriptors}
   *
   * @see {@link Registry#getService}
   *
   * @returns {Promise}
   */
  service(serviceName) {
    console.warn(`client.service() is deprecated as it is passing a serviceDescriptor and not a service.
                  Please use client.serviceDescriptors() instead`);
    return this.serviceDescriptors(serviceName).then(([result]) => result);
  }

  /**
   * Get a list of {@link ServiceDescriptor}s from the service endpoint
   *
   * @see {@link Registry#getServiceDescriptors}
   *
   * @param {...string} serviceNames - service names
   *
   * @returns {Promise}
   */
  serviceDescriptors(...serviceNames) {
    return this.registry.getServiceDescriptors(...serviceNames);
  }

  /**
   * Get a list of {@link ServiceDescriptor}s from the SDK cache, falling back to the service endpoint
   *
   * @see {@link Registry#getCachedServiceDescriptors}
   *
   * @param {...string} serviceNames - service names
   *
   * @returns {Promise}
   */
  cachedServiceDescriptors(...serviceNames) {
    return this.registry.getCachedServiceDescriptors(...serviceNames);
  }

  /**
   * Log an end user in with username and password credentials
   *
   * @param {string?} username - the end user's username
   * @param {string?} password - the end user's password
   * @param {AuthenticationOptions?} options
   *
   * @example
   * // Standard 'pauth' login
   * client.login('test_username', 'test_password').then((session) => {
   *   // Do something with the session
   * });
   *
   * // 'pauth' style login to a custom endpoint
   * client.login('test_username', 'test_password', {
   *   url: 'https://example.com/custom/pauth'
   * }).then((session) => {
   *   // Custom url should return a json response of { 'access_token': &lt;token> }
   *   // Do something with the session
   * });
   * @example
   * // Standard 'oauth' login (password grant)
   * const secret = 'somebase64secret==';
   * client.login('test_username', 'test_password', {
   *   strategy: 'oauth',
   *   secret
   * }).then((session) => {
   *   // Do something with the session
   * });
   *
   * @example
   * // Client oauth (client credentials grant)
   * const secret = 'somebase64secret==';
   * client.login(null, null, {
   *   strategy: 'oauth',
   *   secret
   * }).then((session) => {
   *   // Do something with the session
   * });
   *
   * @example
   * // login will reject when not passing a secret
   * client.login('test_username', 'test_password', {
   *   strategy: 'oauth'
   * }).catch((err) => {
   *   // Inspect `err`
   * });
   *
   * @see {Session#authenticateWithCredentials}
   *
   * @returns {Promise} - First argument to the resolved Promise is the {@link Session} object that
   * has been updatedc
   */
  login(username, password, options = { strategy: 'pauth' }) {
    return this.session
      .authenticateWithCredentials(username, password, options)
      .then(session => this.registry.fetch(session.currentOwner()))
      .then(() => this.session);
  }

  /**
   * Generate a Session from an existing bearer token.
   *
   * It is also useful to use this if you acquire an access token via other means,
   * i.e. an existing oauth mechanism for Sequoia
   *
   * Call this method without a token parameter to instantiate the client for anonymous
   * usage. Note: currently the Sequoia registry does not provide anonymous access.
   * See the below example for how to handle this currently.
   *
   * @param {string?} token - an existing bearer token for an end user
   *
   * @example
   * client.generate('some token').then(doSomething);
   *
   * @example
   * // Anonymous usage:
   * client.generate().catch((err) => {
   *   if (err.response &amp;&amp; err.response.status === 401) {
   *     client.registry.tenant = SQ_DIRECTORY;
   *
   *     client.registry.services.push({
   *       owner: 'root',
   *       name: 'identity',
   *       title: 'Identity Service',
   *       location: SQ_IDENTITY_URL
   *     });
   *
   *     client.registry.services.push({
   *       owner: 'root',
   *       name: 'gateway',
   *       title: 'Gateway Service',
   *       location: client.registry.registryUri.replace('registry', 'gateway')
   *     });
   *   }
   * }).then(doSomething);
   *
   * @returns {Promise} - First argument to the resolved Promise is the `Session` object that
   * has been updated
   */
  generate(token) {
    const p = this.session.authenticateWithToken(token);

    return p
      .then(session => this.registry.fetch(session.currentOwner()))
      .then(() => this.session);
  }

  /**
   * Changes the password of a user
   *
   * @returns null
   */
  changePassword(username, oldPassword, newPassword) {
    return this.session.changePassword(username, oldPassword, newPassword);
  }

  /**
   * Reset the password of a user
   *
   * @returns Object
   */
  resetPassword(username) {
    return this.session.resetPassword(username);
  }

  /**
   * Log out an end user
   *
   * @returns {Session}
   */
  logout() {
    return this.session.destroy();
  }

  /**
   * Set the current tenancy for the user
   *
   * When switching tenancies, [this.registry]{@link Registry} will be
   * repopulated with the services available in that tenancy.
   *
   * Note: existing instances of {@link ServiceDescriptor}s, {@link ResourcefulEndpoint}s etc
   * will not have the 'owner' updated when switching to a new tenancy. See the below
   * example for more info.
   *
   * @param {string} tenantName - the name of the tenancy to use
   *
   * @example &lt;caption>Switching a tenancy&lt;/caption>
   * await client.generate(some_token);
   * await client.setTenancy('test');
   *
   * let identity = await client.service('identity');
   * let usersEndpoint = identity.resourcefulEndpoint('users');
   * await usersEndpoint.browse() // https://&lt;endpoint>/data/users?owner=test
   *
   * await client.setTenancy('production');
   * // At this point `identity` and `usersEndpoint` will still be doing
   * // `fetch`es with `?owner=test`. You will need to repopulate them
   * // as below
   * await usersEndpoint.browse() // https://&lt;endpoint>/data/users?owner=test
   *
   * identity = await client.service('identity');
   * usersEndpoint = identity.resourcefulEndpoint('users');
   * await usersEndpoint.browse() // https://&lt;endpoint>/data/users?owner=production
   *
   * @returns {Promise&lt;Session>}
   */
  setTenancy(tenantName) {
    // If the tenants.length === 0, it indicated that we are logging in
    // as an anonymous user, where the tenants would not have been set.
    if (this.session.tenants.length > 0) {
      const tenantIds = this.session.tenants.map(item => item.name);

      if (!tenantIds.some(n => n === tenantName)) {
        return Promise.reject(new Error('Tenant does not exist'));
      }
    }

    this.session.currentTenant = tenantName;

    // Switching a tenancy whilst we've already logged in requires us
    // to update the registry
    return this.registry
      .fetch(tenantName)
      .then(() => this.session.populateAccess())
      .then(() => this.session);
  }

  /**
   * Set the current directory
   *
   * This will only affect new authentications,
   * if the client is already authenticated, it will not do anything.
   *
   */
  setDirectory(directory) {
    this.session.directory = directory;
  }

  /**
   * Set callback for when the Token is about to expire,
   * will be called before expiry based on the provided threshold
   *
   * Call with null to cancel the callback.
   *
   * @param  {Function} callback Will be called with the current [session.access]{@link Session}
   * @param  {Number} threshold Number of milliseconds _before_ expiry when callback will be invoked. Defaults to 60000 (1 minute)
   */
  onExpiryWarning(callback, threshold = 60000) {
    this.session.setOnExpiryWarning(callback, threshold);
  }
}

// Export the query methods for use in non-es6 module environments.
// e.g.
// const Client = require('@pikselpalette/sequoia-js-client-sdk/dist/sequoia-client.js');
// const { where, field, param, textSearch } = Client;

Client.where = where;
Client.field = field;
Client.param = param;
Client.textSearch = textSearch;

export default Client;
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


	<span class="copyright">
	Piksel Ltd Copyright © 2018
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.2</a>
	
		on Tue Sep 17th 2019
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>
